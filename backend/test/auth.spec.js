// ============================================================
//  à¸§à¸´à¸Šà¸²: Software Testing & DevOps Integration
//  à¸«à¸±à¸§à¸‚à¹‰à¸­: Integration Test à¸”à¹‰à¸§à¸¢ Vitest + Supertest
//  à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸—à¸”à¸ªà¸­à¸š API /api/auth/login à¸‚à¸­à¸‡à¸£à¸°à¸šà¸š Backend à¸ˆà¸£à¸´à¸‡
// ============================================================

import { describe, it, expect, vi, beforeEach } from 'vitest'
import request from 'supertest'  // à¹ƒà¸Šà¹‰à¸¢à¸´à¸‡ HTTP Request à¸ˆà¸³à¸¥à¸­à¸‡à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡ start server

// ------------------------------------------------------------
// ðŸ”¹ à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¹€à¸•à¸£à¸µà¸¢à¸¡ Environment à¸à¹ˆà¸­à¸™à¸—à¸¸à¸ Test (Arrange à¸£à¸°à¸”à¸±à¸š Global)
// ------------------------------------------------------------
beforeEach(() => {
  // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸•à¸±à¸§à¹à¸›à¸£à¸ªà¸ à¸²à¸žà¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹ƒà¸«à¹‰à¸„à¸‡à¸—à¸µà¹ˆ
  // à¹€à¸žà¸·à¹ˆà¸­à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸žà¸¶à¹ˆà¸‡ .env à¸‚à¸­à¸‡à¸£à¸°à¸šà¸šà¸ˆà¸£à¸´à¸‡ (à¸—à¸³à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œà¹à¸™à¹ˆà¸™à¸­à¸™à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡)
  process.env.JWT_SECRET = 'test-secret'
})

// ------------------------------------------------------------
// ðŸ”¹ Mock Repository: à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (DB Layer)
// ------------------------------------------------------------
// à¸à¸²à¸£ mock à¸Šà¹ˆà¸§à¸¢à¹ƒà¸«à¹‰à¹€à¸—à¸ªà¸—à¹Œà¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸•à¹ˆà¸­ MySQL à¸ˆà¸£à¸´à¸‡ à¹à¸•à¹ˆà¸¢à¸±à¸‡à¸•à¸£à¸§à¸ˆ logic à¹„à¸”à¹‰
vi.mock('../repositories/users', () => ({
  findByEmail: vi.fn(async (email) => {
    // à¸ˆà¸³à¸¥à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸°à¸šà¸š (à¸à¸£à¸“à¸µà¸—à¸”à¸ªà¸­à¸š login à¸ªà¸³à¹€à¸£à¹‡à¸ˆ)
    if (email === 't.it01@ccollege.ac.th') {
      return {
        id: 4,
        email,
        name_th: 'à¸„à¸£à¸¹à¹„à¸­à¸—à¸µ 01',
        role: 'evaluatee',        // role à¸•à¸²à¸¡ ENUM à¸ˆà¸£à¸´à¸‡à¹ƒà¸™ schema.sql
        password_hash: '$2b$10$dummy' // mock hash à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ bcrypt.compare à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¹„à¸”à¹‰
      }
    }
    // à¸–à¹‰à¸²à¸­à¸µà¹€à¸¡à¸¥à¹„à¸¡à¹ˆà¸•à¸£à¸‡ à¹ƒà¸«à¹‰à¸„à¸·à¸™ null à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸³à¸¥à¸­à¸‡ â€œà¹„à¸¡à¹ˆà¸žà¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰â€
    return null
  })
}))

// ------------------------------------------------------------
// ðŸ”¹ Mock bcrypt: à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™
// ------------------------------------------------------------
// à¸ˆà¸£à¸´à¸‡ à¹† bcrypt.compare à¸ˆà¸° hash à¹à¸¥à¹‰à¸§à¹€à¸—à¸µà¸¢à¸šà¸„à¹ˆà¸² à¹à¸•à¹ˆà¹€à¸£à¸²à¸—à¸³à¹ƒà¸«à¹‰à¸¡à¸±à¸™à¸•à¸­à¸š true/false à¸•à¸£à¸‡ à¹†
vi.mock('bcrypt', () => ({
  default: {
    compare: async (plain) => plain === 'password123' // à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¹€à¸¡à¸·à¹ˆà¸­à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹€à¸›à¹‡à¸™ "password123"
  }
}))

// ------------------------------------------------------------
// ðŸ”¹ à¸™à¸³à¹€à¸‚à¹‰à¸² Express App à¸ˆà¸£à¸´à¸‡ (à¹à¸•à¹ˆà¹„à¸¡à¹ˆ start server)
// ------------------------------------------------------------
import app from '../app'
// supertest à¸ˆà¸°à¸ˆà¸³à¸¥à¸­à¸‡ request à¸œà¹ˆà¸²à¸™ app à¹„à¸”à¹‰à¹‚à¸”à¸¢à¸•à¸£à¸‡ à¹€à¸Šà¹ˆà¸™ request(app).post(...)

// ============================================================
// ðŸ”¸ à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸Šà¸¸à¸”à¸—à¸”à¸ªà¸­à¸š (Integration Test)
// ============================================================
describe('POST /api/auth/login', () => {

  // ----------------------------------------------------------
  // ðŸ§© CASE 1: à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡ email/password â†’ à¸„à¸§à¸£à¹„à¸”à¹‰ 400 Bad Request
  // ----------------------------------------------------------
  it('400 when email/password missing', async () => {
    // ðŸ”¹ Arrange: (à¹€à¸•à¸£à¸µà¸¢à¸¡à¸žà¸£à¹‰à¸­à¸¡) â€” mock à¹à¸¥à¸° env à¸–à¸¹à¸ set à¹à¸¥à¹‰à¸§
    // ðŸ”¹ Act: à¸¢à¸´à¸‡ request à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸ªà¹ˆà¸‡ body
    const r = await request(app).post('/api/auth/login').send({})
    // ðŸ”¹ Assert: à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸£à¸°à¸šà¸šà¸•à¸­à¸š 400
    expect(r.status).toBe(400)
  })

  // ----------------------------------------------------------
  // ðŸ§© CASE 2: à¸­à¸µà¹€à¸¡à¸¥à¹„à¸¡à¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸°à¸šà¸š â†’ 401 Unauthorized
  // ----------------------------------------------------------
  it('401 when email not found', async () => {
    const r = await request(app).post('/api/auth/login')
      .send({ email: 't.it01@ccollege.ac.th', password: 'password123' })
    expect(r.status).toBe(401)
  })

  // ----------------------------------------------------------
  // ðŸ§© CASE 3: à¸­à¸µà¹€à¸¡à¸¥à¸–à¸¹à¸ à¹à¸•à¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸œà¸´à¸” â†’ 401 Unauthorized
  // ----------------------------------------------------------
  it('401 when wrong password', async () => {
    const r = await request(app).post('/api/auth/login')
      .send({ email: 't.it01@ccollege.ac.th', password: 'password123' })
    expect(r.status).toBe(401)
  })

  // ----------------------------------------------------------
  // ðŸ§© CASE 4: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ â†’ 200 OK + JWT Token + User Info
  // ----------------------------------------------------------
  it('200 returns accessToken and user', async () => {
    const r = await request(app).post('/api/auth/login')
      .send({ email: 't.it01@ccollege.ac.th', password: 'password123' })

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ (Assert)
    expect(r.status).toBe(200)                 // à¸ªà¸–à¸²à¸™à¸° HTTP à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ 200
    expect(r.body.success).toBe(true)          // success flag à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™ true
    expect(r.body).toHaveProperty('accessToken') // à¸•à¹‰à¸­à¸‡à¸¡à¸µ accessToken
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ user à¸§à¹ˆà¸²à¸¡à¸µà¸„à¹ˆà¸²à¸•à¸£à¸‡à¸•à¸²à¸¡ mock à¸—à¸µà¹ˆà¹€à¸•à¸£à¸µà¸¢à¸¡à¹„à¸§à¹‰
    expect(r.body.user).toMatchObject({
      id: 4,
      email: 't.it01@ccollege.ac.th',
      role: 'evaluatee'
    })
  })
})
